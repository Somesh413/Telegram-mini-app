<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fast Paisa - Telegram Mini App</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* CSS waisa ka waisa hai... */
        :root { --primary-green: #25D366; --dark-green: #128C7E; --light-green: #e8f5e9; --text-dark: #333; --text-light: #777; --bg-color: #f7f9fc; --card-bg: #ffffff; --border-color: #e9ecef; --shadow: 0 4px 15px rgba(0, 0, 0, 0.07); }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-dark); padding-bottom: 80px; }
        header { background: var(--card-bg); color: var(--text-dark); padding: 15px 20px; font-size: 22px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .wallet-balance { display: flex; align-items: center; gap: 8px; background: var(--light-green); padding: 8px 15px; border-radius: 20px; font-size: 15px; font-weight: 600; color: var(--dark-green); }
        .wallet-balance img { width: 20px; height: 20px; }
        .section { display: none; padding: 20px; }
        .section.active { display: block; }
        .section h2 { font-size: 20px; font-weight: 600; margin-top: 0; margin-bottom: 20px; }
        .content-card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 15px; }
        .offer-card-detailed { display: flex; align-items: center; gap: 15px; }
        .offer-card-detailed .offer-icon img { width: 60px; height: 60px; border-radius: 12px; flex-shrink: 0; object-fit: cover; }
        .offer-card-detailed .offer-details { flex-grow: 1; }
        .offer-card-detailed .offer-details h4 { margin: 0 0 4px 0; font-size: 16px; font-weight: 600; }
        .offer-card-detailed .offer-details p { margin: 0; font-size: 13px; color: var(--text-light); }
        /* Get Button ko ab button jaisa banaya hai */
        .offer-reward-button { background-color: var(--primary-green); color: white !important; padding: 12px 18px; border-radius: 10px; text-decoration: none; font-weight: 600; font-size: 14px; text-align: center; transition: background-color 0.2s; flex-shrink: 0; border: none; cursor: pointer; }
        .offer-reward-button:hover { background-color: var(--dark-green); }
        /* Baki CSS waisa hi hai... */
    </style>
</head>
<body>
    <header><span>Fast Paisa</span><div class="wallet-balance"><img src="https://cdn-icons-png.flaticon.com/128/891/891462.png" alt="Wallet"> ‚Çπ<span id="wallet">0.00</span></div></header>
    <div id="offers" class="section active"><h2>üéÅ High Paying Offers</h2><div id="offers-list-container"><p>Loading offers...</p></div></div>
    <!-- Baaki saare sections... -->
    <div id="task" class="section">...</div><div id="spin" class="section">...</div><div id="refer" class="section">...</div><div id="withdraw" class="section">...</div>
    <div class="bottom-nav">...</div>

<script>
    const SUPABASE_URL = 'https://msrprmhdifktmrbfegom.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zcnBybWhkaWZrdG1yYmZlZ29tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4MDUwNTcsImV4cCI6MjA2NzM4MTA1N30.krJcMCeEmpdx7770j4jhAKwcfv7K9w8gpJZYK_MPBZE';
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentUser = null; 
    let wallet = 0;
    
    // Baaki saare functions...
    async function getUser(telegram_id) { /*...*/ }
    async function createUser(telegram_id) { /*...*/ }
    async function updateUserCoins(telegram_id, amount) { /*...*/ }
    function updateWallet(amount) { /*...*/ }
    function spinWheel() { /*...*/ }
    function requestWithdrawal() { /*...*/ }
    function renderHistory() { /*...*/ }
    function showSection(id) { /*...*/ }
    
    // === NAYA FUNCTION: Eligibility Popup Dikhane ke liye ===
    function showEligibilityPopup(title, eligibility, link) {
        const WebApp = window.Telegram.WebApp;
        
        // Agar eligibility text nahi hai, toh seedha link khol do
        if (!eligibility) {
            WebApp.openLink(link);
            return;
        }

        WebApp.showConfirm(
            `Eligibility for ${title}:\n\n${eligibility.replace(/\\n/g, '\n')}`, // \n ko ‡¶Ü‡¶∏‡¶≤ newline mein badlo
            (ok) => {
                if (ok) {
                    // Agar user "Continue" par click kare, toh link kholo
                    WebApp.openLink(link);
                }
            },
            'Continue', // OK button ka text
            'Cancel'    // Cancel button ka text
        );
    }

    async function fetchAndRenderOffers() {
        const offersContainer = document.getElementById('offers-list-container');
        const { data, error } = await db.from('offers').select('*').eq('is_active', true);
        
        if (error) {
            console.error("Error fetching offers:", error);
            offersContainer.innerHTML = '<p>Could not load offers. Please try again later.</p>';
            return;
        }

        if (data.length === 0) {
            offersContainer.innerHTML = '<p>No offers available right now. Check back soon!</p>';
            return;
        }
        offersContainer.innerHTML = ''; 

        data.forEach(offer => {
            // === YAHAN BADLAAV KIYA GAYA HAI ===
            // <a> tag ke bajaye ab <button> ka istemal ho raha hai
            const offerCardHTML = `
                <div class="content-card offer-card-detailed">
                    <div class="offer-icon">
                        <img src="${offer.icon_url}" alt="${offer.title} icon">
                    </div>
                    <div class="offer-details">
                        <h4>${offer.title}</h4>
                        <p>${offer.description || ''}</p>
                    </div>
                    <button class="offer-reward-button" 
                            onclick="showEligibilityPopup('${offer.title}', '${offer.eligibility || ''}', '${offer.link}')">
                        Get ‚Çπ${offer.reward}
                    </button>
                </div>
            `;
            offersContainer.innerHTML += offerCardHTML;
        });
    }

    async function initializeApp() {
        try {
            const WebApp = window.Telegram.WebApp;
            WebApp.ready(); 
            WebApp.expand(); 
            
            await fetchAndRenderOffers();
            
            if (!WebApp.initDataUnsafe || !WebApp.initDataUnsafe.user) {
                throw new Error("Could not get user data from Telegram.");
            }
            const telegram_id = WebApp.initDataUnsafe.user.id;
            
            let user = await getUser(telegram_id);
            if (!user) { user = await createUser(telegram_id); }
            if (!user) { throw new Error("Could not fetch or create user."); }

            currentUser = user;
            wallet = currentUser.coins;
            document.getElementById('wallet').innerText = wallet.toFixed(2);
        } catch (error) {
            console.error("Initialization failed:", error);
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.showAlert("CRITICAL ERROR: " + error.message);
            } else {
                alert("CRITICAL ERROR: " + error.message);
            }
        }
    }

    window.addEventListener('load', initializeApp);

    // Placeholder for other functions to avoid breaking the code
    async function getUser(telegram_id) { const { data, error } = await db.from('users').select('*').eq('telegram_id', telegram_id).single(); if (error && error.code !== 'PGRST116') throw error; return data; }
    async function createUser(telegram_id) { const { data, error } = await db.from('users').insert({ telegram_id: telegram_id, coins: 0 }).select().single(); if (error) throw error; return data; }
</script>
</body>
  </html>
